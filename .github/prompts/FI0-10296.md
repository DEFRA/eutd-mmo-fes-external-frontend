# Implementation Prompt: FI0-10296 - Remove Product Page for Processing Statement

## Executive Summary

Implement a confirmation page for removing products from Processing Statement documents. This page follows the same pattern as the existing delete draft functionality but with key differences: it operates on product-level (not document-level), supports "Save as draft" button, and has conditional navigation based on remaining products.

## Context & Reference Materials

### User Story Reference

- **Location**: `.github/stories/FI0-10296.md`
- **Journey**: Processing Statement
- **Route**: `/create-processing-statement/:documentNumber/remove-product/:productId`

### Key Reference Implementations

1. **Delete Draft Pattern** (Similar UI/UX):

   - Component: `app/composite-components/deleteDraft.tsx`
   - Route: `app/routes/create-catch-certificate.$documentNumber.delete-this-draft-catch-certificate.tsx`
   - Server Logic: `app/.server/documentConfirmDeleteDraft.ts`
   - Tests: `tests/cypress/integration/routes/deleteThisDraftProcessingStatement.spec.ts`

2. **Processing Statement Product Management**:

   - Catch Added Page: `app/routes/create-processing-statement.$documentNumber.catch-added.tsx`
   - Add Consignment Details: `app/routes/create-processing-statement.$documentNumber.add-consignment-details.$.tsx`
   - Server Functions: `app/.server/processingStatement.ts`
     - `removeProcessingStatementProduct()` - Filters products/catches client-side, then calls orchestration API
     - Returns: `{ errorResponse, data }` structure
     - Handles: validation errors, unauthorised responses, and successful data updates

3. **Button Group Pattern** (Save as Draft + Save and Continue):
   - Component: `app/composite-components/buttonGroup.tsx`
   - Used in: Multiple Processing Statement routes

## Technical Requirements

### 1. Server Function Pattern

**File**: `app/.server/processingStatement.ts`

The `removeProcessingStatementProduct` function follows this pattern:

```typescript
export const removeProcessingStatementProduct = async (
  bearerToken: string,
  documentNumber: string | undefined,
  currentUrl: string,
  saveToRedisIfErrors: boolean = false,
  returnDataOnly?: boolean
) => {
  // 1. Extract productId from URL
  const productId = currentUrl.split("/").pop();

  // 2. Fetch current Processing Statement
  const psData = await getProcessingStatement(bearerToken, documentNumber);

  // 3. Validate response (handles 403, errors)
  const errorResponse = validateResponseData(psData);
  if (errorResponse) {
    return { errorResponse, data: psData };
  }

  // 4. Filter products and catches (client-side filtering)
  const currentProcessingStatement = psData as ProcessingStatement;
  const updatedProcessingStatement: ProcessingStatement = {
    ...currentProcessingStatement,
    products: currentProcessingStatement.products?.filter((product) => product.id !== productId),
    catches: currentProcessingStatement.catches?.filter((catchItem) => catchItem.productId !== productId),
  };

  // 5. Save filtered data via orchestration API
  const updatedData = await addProcessingDetails(
    bearerToken,
    documentNumber,
    updatedProcessingStatement,
    currentUrl,
    saveToRedisIfErrors
  );

  // 6. Validate final response
  const finalErrorResponse = validateResponseData(updatedData, undefined, returnDataOnly);
  return {
    errorResponse: finalErrorResponse,
    data: updatedData,
  };
};
```

**Key Points:**

- Returns object with `{ errorResponse, data }` structure
- `errorResponse` is undefined on success, or contains error Response on failure
- `data` contains ProcessingStatement or IUnauthorised
- Client-side filtering before API call (atomic operation)

### 2. Route Implementation

**File**: `app/routes/create-processing-statement.$documentNumber.remove-product.$productId.tsx`

#### Loader Function Requirements:

```typescript
export const loader: LoaderFunction = async ({ request, params }) => {
  /* istanbul ignore next */
  setApiMock(request.url); // CRITICAL: Must be first line for test mocking

  const { documentNumber, productId } = params;
  const bearerToken = await getBearerTokenForRequest(request);

  // 1. Fetch Processing Statement data
  const psData = await getProcessingStatement(bearerToken, documentNumber);

  // 2. Get product description for the specific product
  const { currentProductDescription } = getProductDescription(psData.products, productId);

  // 3. Create CSRF token
  const csrf = createCSRFToken();
  const session = await getSessionFromRequest(request);
  session.set("csrf", csrf);

  // 4. Return data
  return json(
    {
      csrf,
      documentNumber,
      productId,
      productDescription: currentProductDescription?.productDescription || "",
    },
    {
      headers: { "Set-Cookie": await commitSession(session) },
    }
  );
};
```

#### Action Function Requirements:

```typescript
export const action: ActionFunction = async ({ request, params }) => {
  const { documentNumber, productId } = params;
  const formData = await request.formData();
  const bearerToken = await getBearerTokenForRequest(request);

  // 1. Validate CSRF token
  const isValid = await validateCSRFToken(request, formData);
  if (!isValid) return redirect("/forbidden");

  // 2. Get form values
  const removeProduct = formData.get("removeProduct") as string;
  const actionType = formData.get("actionType") as string; // 'saveAndContinue' or 'saveAsDraft'

  // 3. Validate radio selection
  if (!removeProduct) {
    return json({
      errors: {
        removeProduct: {
          message: "removeProductErrorNoSelection", // i18n key
        },
      },
    });
  }

  // 4. Handle "Save as draft" - always go to progress
  if (actionType === "saveAsDraft") {
    return redirect(route("/create-processing-statement/:documentNumber/progress", { documentNumber }));
  }

  // 5. Handle "Save and continue" with "No" - go back to catch-added
  if (removeProduct === "No") {
    return redirect(route("/create-processing-statement/:documentNumber/catch-added", { documentNumber }));
  }

  // 6. Handle "Save and continue" with "Yes" - delete product
  if (removeProduct === "Yes") {
    // Call API to remove product and associated catches
    const result = await removeProcessingStatementProduct(
      bearerToken,
      documentNumber,
      `/create-processing-statement/${documentNumber}/remove-product/${productId}`,
      false, // saveToRedisIfErrors
      false // returnDataOnly
    );

    // Handle error response from removeProcessingStatementProduct
    if (result.errorResponse) {
      return result.errorResponse;
    }

    // Handle unauthorised response
    if (instanceOfUnauthorised(result.data)) {
      return redirect("/forbidden");
    }

    // Cast to ProcessingStatement - we know it's valid at this point
    const updatedData = result.data as ProcessingStatement;
    const hasRemainingProducts = updatedData?.products && updatedData.products.length > 0;

    if (hasRemainingProducts) {
      // Scenario 2: Navigate back to catch-added
      return redirect(route("/create-processing-statement/:documentNumber/catch-added", { documentNumber }));
    } else {
      // Scenario 3: Navigate to add-consignment-details, mark section incomplete
      // Note: Section status is handled by backend/progress calculation
      return redirect(`/create-processing-statement/${documentNumber}/add-consignment-details`);
    }
  }

  // Default fallback - redirect to catch-added
  return redirect(route("/create-processing-statement/:documentNumber/catch-added", { documentNumber }));
};
```

### 2. Component Creation

**File**: `app/composite-components/removeProduct.tsx`

Create a new component similar to `deleteDraft.tsx` but with:

- Dynamic product description in heading
- Radio buttons labeled "Yes" / "No" (inline layout)
- Two-button layout (ButtonGroup component)
- Back to progress link

```typescript
interface Props {
  errors: IErrorsTransformed;
  csrf: string;
  productDescription: string;
  documentNumber: string;
}

export const RemoveProduct = ({ errors, csrf, productDescription, documentNumber }: Props) => {
  const { t } = useTranslation(['removeProduct', 'common']);

  return (
    <>
      <SecureForm method="post" csrf={csrf}>
        <div className={`govuk-form-group ${!isEmpty(errors) ? "govuk-form-group--error" : ""}`}>
          <fieldset className="govuk-fieldset">
            <legend className="govuk-fieldset__legend govuk-fieldset__legend--xl">
              <h1 className="govuk-heading-xl">
                {t('removeProduct:pageTitle')}
              </h1>
            </legend>

            <p className="govuk-body">
              {t('removeProduct:question', { productDescription })}
            </p>

            {!isEmpty(errors) && (
              <ErrorMessage
                id="removeProduct-error"
                text={t(errors?.removeProduct?.message, { ns: 'errorsText' })}
                visuallyHiddenText={t('commonErrorText', { ns: 'errorsText' })}
              />
            )}

            <div className="govuk-radios govuk-radios--inline" data-module="govuk-radios">
              <div className="govuk-radios__item">
                <input
                  className="govuk-radios__input"
                  id="removeProduct"
                  name="removeProduct"
                  type="radio"
                  value="Yes"
                  data-testid="removeProduct-yes"
                />
                <label className="govuk-label govuk-radios__label" htmlFor="removeProduct">
                  {t('common:commonYesLabel')}
                </label>
              </div>
              <div className="govuk-radios__item">
                <input
                  className="govuk-radios__input"
                  id="removeProductNo"
                  name="removeProduct"
                  type="radio"
                  value="No"
                  data-testid="removeProduct-no"
                />
                <label className="govuk-label govuk-radios__label" htmlFor="removeProductNo">
                  {t('common:commonNoLabel')}
                </label>
              </div>
            </div>
          </fieldset>
        </div>

        <ButtonGroup />
      </SecureForm>

      <BackToProgressLink documentNumber={documentNumber} journey="processingStatement" />
    </>
  );
};
```

### 3. Page Component

**File**: `app/routes/create-processing-statement.$documentNumber.remove-product.$productId.tsx`

```typescript
const RemoveProductPage = () => {
  const { csrf, productDescription, documentNumber } = useLoaderData<typeof loader>();
  const { errors = {} } = useActionData<{ errors: any }>() ?? {};

  useScrollOnPageLoad();

  return (
    <Main backUrl={route('/create-processing-statement/:documentNumber/catch-added', { documentNumber })}>
      {!isEmpty(errors) && <ErrorSummary errors={displayErrorMessages(errors)} />}
      <div className="govuk-grid-row">
        <div className="govuk-grid-column-three-quarters">
          <RemoveProduct
            errors={errors}
            csrf={csrf}
            productDescription={productDescription}
            documentNumber={documentNumber}
          />
        </div>
      </div>
    </Main>
  );
};
```

### 4. Translation Files

#### English (`public/locales-v2/en/removeProduct.json`):

```json
{
  "pageTitle": "Remove a product",
  "question": "Do you want to remove '{{productDescription}}' and all its associated species?"
}
```

#### Welsh (`public/locales-v2/cy/removeProduct.json`):

```json
{
  "pageTitle": "Tynnwch gynnyrch",
  "question": "Hoffech chi dynnu '{{productDescription}}' a'r holl rywogaethau cysylltiedig?"
}
```

#### Error Messages (`public/locales-v2/en/errorsText.json`):

Add:

```json
{
  "removeProductErrorNoSelection": "Select yes if you want to remove this product and all its associated species"
}
```

#### Welsh Error (`public/locales-v2/cy/errorsText.json`):

Add:

```json
{
  "removeProductErrorNoSelection": "Dewiswch 'ydw' os hoffech chi dynnu'r cynnyrch hwn a'r holl rywogaethau cysylltiedig"
}
```

## Testing Implementation (MSW + Cypress)

### Step 1: Add Test Case IDs

**File**: `app/types/tests.ts`

Add to `TestCaseId` enum:

```typescript
export enum TestCaseId {
  // ... existing cases

  // FI0-10296: Remove Product Page
  RemoveProductPageLoads = "removeProductPageLoads",
  RemoveProductYesSaveAndContinueWithProducts = "removeProductYesSaveAndContinueWithProducts",
  RemoveProductYesSaveAndContinueNoProducts = "removeProductYesSaveAndContinueNoProducts",
  RemoveProductYesSaveAsDraft = "removeProductYesSaveAsDraft",
  RemoveProductNoSaveAndContinue = "removeProductNoSaveAndContinue",
  RemoveProductNoSaveAsDraft = "removeProductNoSaveAsDraft",
  RemoveProductNoSelection = "removeProductNoSelection",
  RemoveProductWelsh = "removeProductWelsh",
  RemoveProductNonJS = "removeProductNonJS",
  RemoveProductAccessibility = "removeProductAccessibility",
  RemoveProductFromAdmin = "removeProductFromAdmin",
}
```

### Step 2: Create Mock Fixtures

**File**: `tests/cypress/fixtures/removeProduct/removeProductScenarios.json`

```json
{
  "processingStatementWithMultipleProducts": {
    "documentNumber": "GBR-2022-PS-F0285BD8A",
    "products": [
      {
        "id": "product-123",
        "productDescription": "Frozen Atlantic Salmon Fillets"
      },
      {
        "id": "product-456",
        "productDescription": "Smoked Mackerel"
      }
    ],
    "catches": [
      { "_id": "catch-1", "productId": "product-123" },
      { "_id": "catch-2", "productId": "product-456" }
    ]
  },
  "processingStatementSingleProduct": {
    "documentNumber": "GBR-2022-PS-F0285BD8A",
    "products": [
      {
        "id": "product-123",
        "productDescription": "Frozen Atlantic Salmon Fillets"
      }
    ],
    "catches": [{ "_id": "catch-1", "productId": "product-123" }]
  },
  "processingStatementAfterRemoval": {
    "documentNumber": "GBR-2022-PS-F0285BD8A",
    "products": [
      {
        "id": "product-456",
        "productDescription": "Smoked Mackerel"
      }
    ],
    "catches": [{ "_id": "catch-2", "productId": "product-456" }]
  },
  "processingStatementNoProducts": {
    "documentNumber": "GBR-2022-PS-F0285BD8A",
    "products": [],
    "catches": []
  }
}
```

### Step 3: Create MSW Handler

**File**: `tests/msw/handlers/removeProductHandler.ts`

```typescript
import { rest } from "msw";
import { TestCaseId, type ITestHandler } from "~/types";
import { GET_PROCESSING_STATEMENT_URL, REMOVE_PRODUCT_URL } from "~/urls.server";
import multipleProducts from "@/fixtures/removeProduct/removeProductScenarios.json";

const removeProductHandler: ITestHandler = {
  [TestCaseId.RemoveProductPageLoads]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
  ],

  [TestCaseId.RemoveProductYesSaveAndContinueWithProducts]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) => {
      // First call returns original data, second returns data after removal
      const callCount = req.url.searchParams.get("_count") || "0";
      if (callCount === "0") {
        return res(ctx.json(multipleProducts.processingStatementWithMultipleProducts));
      }
      return res(ctx.json(multipleProducts.processingStatementAfterRemoval));
    }),
    rest.post(REMOVE_PRODUCT_URL, (req, res, ctx) => res(ctx.status(200))),
    // Mock catch-added page loader
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementAfterRemoval))
    ),
  ],

  [TestCaseId.RemoveProductYesSaveAndContinueNoProducts]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) => {
      const callCount = req.url.searchParams.get("_count") || "0";
      if (callCount === "0") {
        return res(ctx.json(multipleProducts.processingStatementSingleProduct));
      }
      return res(ctx.json(multipleProducts.processingStatementNoProducts));
    }),
    rest.post(REMOVE_PRODUCT_URL, (req, res, ctx) => res(ctx.status(200))),
    // Mock add-consignment-details page loader
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementNoProducts))
    ),
  ],

  [TestCaseId.RemoveProductYesSaveAsDraft]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
    // Mock progress page loader
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
  ],

  [TestCaseId.RemoveProductNoSaveAndContinue]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
    // Mock catch-added page loader
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
  ],

  [TestCaseId.RemoveProductNoSaveAsDraft]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
    // Mock progress page loader
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
  ],

  [TestCaseId.RemoveProductNoSelection]: () => [
    rest.get(GET_PROCESSING_STATEMENT_URL, (req, res, ctx) =>
      res(ctx.json(multipleProducts.processingStatementWithMultipleProducts))
    ),
  ],
};

export default removeProductHandler;
```

**File**: `tests/msw/handlers/index.ts`
Add import and merge:

```typescript
import removeProductHandler from "./removeProductHandler";

export const rootTestHandler: ITestHandler = {
  ...existingHandlers,
  ...removeProductHandler,
};
```

### Step 4: Create Cypress Test Spec

**File**: `tests/cypress/integration/routes/removeProduct.spec.ts`

```typescript
import { type ITestParams, TestCaseId } from "~/types";

const documentNumber = "GBR-2022-PS-F0285BD8A";
const productId = "product-123";
const removeProductUrl = `/create-processing-statement/${documentNumber}/remove-product/${productId}`;

describe("Remove Product Page - FI0-10296", () => {
  describe("Scenario 1 - Page Structure", () => {
    it("should display correct page title and question with product description", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductPageLoads,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.contains("h1", "Remove a product").should("be.visible");
      cy.contains("Do you want to remove 'Frozen Atlantic Salmon Fillets' and all its associated species?").should(
        "be.visible"
      );
    });

    it("should have Yes and No radio buttons displayed inline", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductPageLoads,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-yes"]').should("be.visible");
      cy.get('[data-testid="removeProduct-no"]').should("be.visible");
      cy.get(".govuk-radios--inline").should("exist");
    });

    it("should display Back link at top", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductPageLoads,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get("a.govuk-back-link").should("be.visible");
    });

    it("should display Save as draft and Save and continue buttons", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductPageLoads,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="saveAsDraft"]').should("be.visible").should("contain", "Save as draft");
      cy.get('[data-testid="continue"]').should("be.visible").should("contain", "Save and continue");
    });

    it("should display Back to your progress link", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductPageLoads,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.contains("a", "Back to your progress").should("be.visible");
    });
  });

  describe("Scenario 2 - Yes + Save and continue + other products remaining", () => {
    it("should remove product and navigate to catch-added", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductYesSaveAndContinueWithProducts,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-yes"]').check();
      cy.get('[data-testid="continue"]').click();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/catch-added`);
    });
  });

  describe("Scenario 3 - Yes + Save and continue + no other products remaining", () => {
    it("should remove product and navigate to add-consignment-details", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductYesSaveAndContinueNoProducts,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-yes"]').check();
      cy.get('[data-testid="continue"]').click();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/add-consignment-details`);
    });
  });

  describe("Scenario 4 - Yes + Save as draft", () => {
    it("should not remove product and navigate to progress", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductYesSaveAsDraft,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-yes"]').check();
      cy.get('[data-testid="saveAsDraft"]').click();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/progress`);
    });
  });

  describe("Scenario 5 - No + Save and continue", () => {
    it("should not remove product and navigate to catch-added", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductNoSaveAndContinue,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-no"]').check();
      cy.get('[data-testid="continue"]').click();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/catch-added`);
    });
  });

  describe("Scenario 6 - No + Save as draft", () => {
    it("should not remove product and navigate to progress", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductNoSaveAsDraft,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-no"]').check();
      cy.get('[data-testid="saveAsDraft"]').click();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/progress`);
    });
  });

  describe("Scenario 7 - Welsh translations", () => {
    it("should display all text in Welsh", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductWelsh,
        lng: "cy",
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.contains("h1", "Tynnwch gynnyrch").should("be.visible");
      cy.contains("Hoffech chi dynnu 'Frozen Atlantic Salmon Fillets' a'r holl rywogaethau cysylltiedig?").should(
        "be.visible"
      );
      cy.get('[data-testid="removeProduct-yes"]').parent().should("contain", "Ydw");
      cy.get('[data-testid="removeProduct-no"]').parent().should("contain", "Nac ydw");
    });
  });

  describe("Scenario 8 - Admin app access", () => {
    it("should work when accessed from Admin app", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductFromAdmin,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.contains("h1", "Remove a product").should("be.visible");
      // Test same functionality as Scenario 1-7
    });
  });

  describe("Scenario 9 - Non-JS functionality", () => {
    it("should work without JavaScript", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductNonJS,
        disableScripts: true,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="removeProduct-yes"]').check();
      cy.get("form").submit();

      cy.url().should("include", `/create-processing-statement/${documentNumber}/catch-added`);
    });
  });

  describe("Scenario 10 - Accessibility", () => {
    it("should be accessible and comply with GDS guidelines", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductAccessibility,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      // Check ARIA attributes
      cy.get("fieldset").should("exist");
      cy.get("legend").should("exist");
      cy.get(".govuk-radios__input").should("have.attr", "type", "radio");

      // Check labels are properly associated
      cy.get('[data-testid="removeProduct-yes"]').should("have.attr", "id", "removeProduct");
      cy.get('label[for="removeProduct"]').should("exist");
    });
  });

  describe("Error Handling - No selection", () => {
    it("should display error when no radio button selected", () => {
      const testParams: ITestParams = {
        testCaseId: TestCaseId.RemoveProductNoSelection,
      };
      cy.visit(removeProductUrl, { qs: { ...testParams } });

      cy.get('[data-testid="continue"]').click();

      cy.contains("h2", "There is a problem").should("be.visible");
      cy.contains("Select yes if you want to remove this product and all its associated species").should("be.visible");
      cy.get("#removeProduct-error").should("be.visible");
    });
  });
});
```

### Step 5: Export Component

**File**: `app/composite-components/index.ts`

Add:

```typescript
export { RemoveProduct } from "./removeProduct";
```

## Implementation Checklist

### Phase 1: Core Implementation

- [ ] Create route file: `app/routes/create-processing-statement.$documentNumber.remove-product.$productId.tsx`
- [ ] Implement loader function with `setApiMock()` as first line
- [ ] Implement action function with all scenarios (2-6)
- [ ] Create component: `app/composite-components/removeProduct.tsx`
- [ ] Add English translations: `public/locales-v2/en/removeProduct.json`
- [ ] Add Welsh translations: `public/locales-v2/cy/removeProduct.json`
- [ ] Add error messages to both EN/WL `errorsText.json` files
- [ ] Export component in `app/composite-components/index.ts`

### Phase 2: Testing Setup

- [ ] Add test case IDs to `app/types/tests.ts`
- [ ] Create mock fixtures: `tests/cypress/fixtures/removeProduct/removeProductScenarios.json`
- [ ] Create MSW handler: `tests/msw/handlers/removeProductHandler.ts`
- [ ] Integrate handler in `tests/msw/handlers/index.ts`
- [ ] Create Cypress spec: `tests/cypress/integration/routes/removeProduct.spec.ts`

### Phase 3: Testing & Validation

- [ ] Run instrumented build: `npm run pre:test:start`
- [ ] Start test server: `npm run :test:start`
- [ ] Run Cypress tests: `npm run :test:spec tests/cypress/integration/routes/removeProduct.spec.ts`
- [ ] Verify all test scenarios pass (including error handling)
- [ ] Check coverage report: `coverage/lcov-report/index.html`
- [ ] Ensure >90% coverage for new files
- [ ] Verify error handling paths are covered:
  - [ ] `result.errorResponse` return path (validation errors)
  - [ ] `instanceOfUnauthorised(result.data)` path (403 responses)
  - [ ] Default fallback return path (invalid radio values)

### Phase 4: Build & Quality

- [ ] Run production build: `npm run build`
- [ ] Fix any TypeScript errors
- [ ] Run linting: `npm run lint`
- [ ] Check for MSW warnings in server console
- [ ] Test manually in browser (both EN and WL)
- [ ] Test with JavaScript disabled
- [ ] Verify progressive enhancement works

## Critical Implementation Notes

### 1. removeProcessingStatementProduct Return Structure

- **Returns**: `{ errorResponse, data }` object
- `errorResponse`: undefined on success, or ErrorResponse/TypedResponse on failure
- `data`: ProcessingStatement or IUnauthorised
- **Route must check both**:
  ```typescript
  if (result.errorResponse) {
    return result.errorResponse; // Return error to display on page
  }
  if (instanceOfUnauthorised(result.data)) {
    return redirect("/forbidden"); // Handle unauthorised
  }
  const updatedData = result.data as ProcessingStatement; // Safe to cast
  ```

### 2. CSRF Protection

- **MUST** use `<SecureForm>` component with CSRF token
- **MUST** validate CSRF token in action before processing
- Redirect to `/forbidden` if CSRF validation fails

### 3. MSW Testing Pattern

- **MUST** add `setApiMock(request.url)` as FIRST line in loader
- **MUST** mock ALL API calls in test journey including destination page loaders
- Use `res` not `res.once` (test case ID persists across navigation)
- Watch server console for `[MSW] Warning` messages
- Mock POST to `mockGetAddProcessingStatementUrl` (orchestration saveAndValidate endpoint)

### 4. Progressive Enhancement

- Form MUST work without JavaScript enabled
- Test with `disableScripts: true` in test params
- Use native HTML form submission, not React state

### 4. Bilingual Support

- **NEVER** leave Welsh translations as TODO or placeholder
- Both EN and WL files must be complete before PR
- Use i18next interpolation for dynamic content: `{{productDescription}}`

### 5. GOV.UK Design Patterns

- Use inline radios: `govuk-radios--inline`
- Use ButtonGroup component for dual-button layout
- Follow GOV.UK spacing and typography classes
- No custom CSS unless absolutely unavoidable

### 6. Error Handling

- Display error summary at top when validation fails
- Field-level error messages below question
- Use GOV.UK error message component
- Proper ARIA attributes for accessibility
- **Always check `result.errorResponse` first** before proceeding with data processing

### 7. Atomic Product + Catches Removal

- `removeProcessingStatementProduct` filters BOTH products and catches arrays
- All catches with matching `productId` are removed in same operation
- Client-side filtering ensures atomic operation
- Backend validation handler confirms filtered data structure

## API Endpoints Required

The implementation uses existing Processing Statement endpoints:

```typescript
// In app/urls.server.ts
export const GET_PROCESSING_STATEMENT = "..."; // Fetch PS data
export const getAddProcessingStatementUrl = (currentUrl, saveToRedisIfErrors) => "...";
// Returns orchestration saveAndValidate endpoint
```

**Key Point**: No dedicated DELETE endpoint needed. The route uses:

1. `getProcessingStatement()` - Fetch current data
2. `removeProcessingStatementProduct()` - Filter products/catches client-side
3. `addProcessingDetails()` - POST filtered data to orchestration API
4. Orchestration validation handler validates the filtered payload

## Success Criteria

Implementation is complete when:

1. ✅ All Cypress test scenarios pass with instrumented build
2. ✅ Code coverage >90% for new route and component
3. ✅ Production build succeeds: `npm run build`
4. ✅ No linting errors: `npm run lint`
5. ✅ No MSW warnings in test server console
6. ✅ Both English and Welsh translations complete
7. ✅ CSRF protection working
8. ✅ Progressive enhancement verified (works without JS)
9. ✅ GOV.UK accessible markup validated
10. ✅ Manual testing in browser confirms all scenarios

## Confidence Level Target

**95/100** - All scenarios tested, full coverage, production-ready code

## References for Developer

- Remix docs: https://remix.run/docs
- GOV.UK Design System: https://design-system.service.gov.uk/
- MSW docs: https://mswjs.io/docs/
- Cypress docs: https://docs.cypress.io/

---

**Implementation Start Date**: [To be filled]
**Estimated Effort**: 4-6 hours
**Assigned To**: [To be filled]
